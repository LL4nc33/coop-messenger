FROM golang:1.24-bookworm AS builder

ARG VERSION=dev
ARG COMMIT=unknown
ARG NODE_MAJOR=18

RUN apt-get update && apt-get install -y \
       build-essential ca-certificates curl gnupg \
    && mkdir -p /etc/apt/keyrings \
    && curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg \
    && echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_$NODE_MAJOR.x nodistro main" >> /etc/apt/sources.list.d/nodesource.list \
    && apt-get update \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app
ADD Makefile .

# Prepare server directory for web-build output
RUN mkdir -p server/docs && touch server/docs/index.html

# web
ADD ./web/package.json ./web/package-lock.json ./web/
RUN make web-deps
ADD ./web ./web
RUN make web-build

# cli & server
ADD go.mod go.sum main.go ./
ADD ./cmd ./cmd
ADD ./log ./log
ADD ./server ./server
ADD ./user ./user
ADD ./util ./util
ADD ./payments ./payments
RUN make VERSION=$VERSION COMMIT=$COMMIT cli-linux-server

FROM alpine

LABEL org.opencontainers.image.title="Coop"
LABEL org.opencontainers.image.description="Self-hosted private messenger"

RUN apk add --no-cache tzdata
COPY --from=builder /app/dist/coop_linux_server/coop /usr/bin/ntfy

EXPOSE 80/tcp
ENTRYPOINT ["ntfy"]
